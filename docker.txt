é–‹ç™ºç’°å¢ƒã¯AWS EC2ã€‚æ¯æ—¥ãƒªãƒ–ãƒ¼ãƒˆã™ã‚‹ã€‚æ¯æ—¥docker load -i maven-image.tar ã™ã‚‹


#/usr/local/bin/load-docker-images.sh
#!/bin/bash
docker image inspect maven:3.9.5-eclipse-temurin-21 > /dev/null 2>&1
if [ $? -ne 0 ]; then
  docker load -i /opt/images/maven-image.tar
fi


#systemd ç™»éŒ²ä¾‹ï¼ˆ/etc/systemd/system/load-docker-images.serviceï¼‰
[Unit]
Description=Load Docker image for GitLab CI
After=docker.service

[Service]
ExecStart=/usr/local/bin/load-docker-images.sh
Type=oneshot
RemainAfterExit=true

[Install]
WantedBy=multi-user.target



#ã‚³ãƒãƒ³ãƒ‰
sudo systemctl enable load-docker-images.service



âœ… Gitã‚µãƒ¼ãƒãƒ¼ã«æŒã¡è¾¼ã‚€ã¹ãã‚‚ã®ï¼ˆEBS æ°¸ç¶šåŒ–ï¼‹è‡ªå‹• docker load å¯¾å¿œï¼‰
ç¨®åˆ¥	ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»å†…å®¹	å‚™è€ƒ
ğŸ³ Dockeræœ¬ä½“	docker-<version>.tgz	ä¾‹: docker-28.2.2.tgzï¼ˆå…¬å¼ãƒã‚¤ãƒŠãƒªï¼‰
ğŸ”§ Dockerãƒã‚¤ãƒŠãƒªé…ç½®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ	install-docker-offline.sh	/usr/bin ã¸ dockerd ãªã©ã‚’é…ç½®
ğŸ§± Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆMavenï¼‰	maven-image.tar	ä¾‹: maven:3.9.5-eclipse-temurin-21 ã‚’ docker save ã—ãŸã‚‚ã®
ğŸ“¦ ã‚¤ãƒ¡ãƒ¼ã‚¸æ ¼ç´ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª	/opt/images/	.tar ã‚’ã“ã“ã«é…ç½®ã™ã‚‹æƒ³å®š
ğŸ–¥ï¸ systemd ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«	/etc/systemd/system/docker-image-load.service	docker load ã‚’è‡ªå‹•å®Ÿè¡Œ
ğŸ§­ systemd èµ·å‹•è¨­å®šã‚¹ã‚¯ãƒªãƒ—ãƒˆ	enable-docker-load.sh	systemctl enable docker-image-load ãªã©å®Ÿè¡Œç”¨

| ãƒ•ã‚¡ã‚¤ãƒ« | èª¬æ˜ |
|---------|------|
| `docker-28.2.2.tgz` | Dockeræœ¬ä½“ï¼ˆ[å…¬å¼ãƒã‚¤ãƒŠãƒª](https://download.docker.com/linux/static/stable/x86_64/)ï¼‰ |
| `maven-image.tar` | CIç”¨ã®Mavenã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆ`docker save`ã§ä½œæˆï¼‰ |
| `install-docker-offline.sh` | Dockeræœ¬ä½“ã‚’é…ç½®ãƒ»ã‚µãƒ¼ãƒ“ã‚¹åŒ–ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `docker-image-load.service` | Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ systemd ã‚µãƒ¼ãƒ“ã‚¹ |
| `enable-docker-load.sh` | ã‚µãƒ¼ãƒ“ã‚¹ã‚’ systemd ã«ç™»éŒ²ãƒ»æœ‰åŠ¹åŒ–ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

### âœ… `install-docker-offline.sh`
```bash
#!/bin/bash
set -e

# Dockeré…ç½®
mkdir -p /usr/bin
cd /tmp

# è§£å‡ & ã‚³ãƒ”ãƒ¼ï¼ˆdocker-28.2.2.tgz ã¯åŒéšå±¤ã«ã‚ã‚‹å‰æï¼‰
tar xzvf docker-28.2.2.tgz
cp docker/* /usr/bin/

# dockerd ã‚½ã‚±ãƒƒãƒˆä½œæˆç”¨ã« group è¿½åŠ 
getent group docker || groupadd docker

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
/usr/bin/docker version
```

---

### âœ… `docker-image-load.service`
```ini
[Unit]
Description=Load Maven Docker image for GitLab CI
After=docker.service
Requires=docker.service

[Service]
Type=oneshot
ExecStart=/usr/bin/docker load -i /opt/images/maven-image.tar
RemainAfterExit=true

[Install]
WantedBy=multi-user.target
```

---

### âœ… `enable-docker-load.sh`
```bash
#!/bin/bash
set -e

# é…ç½®å…ˆä½œæˆã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚³ãƒ”ãƒ¼ï¼ˆä¾‹ï¼‰
mkdir -p /opt/images
cp maven-image.tar /opt/images/
cp docker-image-load.service /etc/systemd/system/

# systemd ç™»éŒ²
systemctl daemon-reload
systemctl enable docker-image-load.service
```

---

### âœ… æ‰‹é †ã¾ã¨ã‚ï¼ˆGitã‚µãƒ¼ãƒãƒ¼å´ã§ä¸€åº¦ã ã‘å®Ÿè¡Œï¼‰
```bash
chmod +x install-docker-offline.sh enable-docker-load.sh
./install-docker-offline.sh
./enable-docker-load.sh
```

---

ã“ã‚Œã§ã€Gitã‚µãƒ¼ãƒãƒ¼ãŒæ¯æ—¥ãƒªãƒ–ãƒ¼ãƒˆã—ã¦ã‚‚è‡ªå‹•ã§ `maven:3.9.5-eclipse-temurin-21` ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã‚‚CIãŒå®‰å®šç¨¼åƒã—ã¾ã™ã€‚

è¤‡æ•°ã® `.tar` ã‚’æ‰±ã„ãŸã„å ´åˆã¯ `docker load` è¡Œã‚’å¢—ã‚„ã›ã°OKã§ã™ã€‚
